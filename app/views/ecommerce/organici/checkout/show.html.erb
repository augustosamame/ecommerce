  <section class="noo-page-heading eff">
    <div class="container">
      <div class="noo-heading-content">
        <h1 class="page-title eff">Checkout</h1>
        <div class="noo-page-breadcrumb eff">
          <a href="./" class="home">ExpatShop Perú</a>/<span>Checkout</span>
        </div>
      </div>
    </div>
  </section>
  <div class="main">
    <div class="commerce commerce-page commerce-checkout">
      <div class="container">
        <div class="row">
          <div class="noo-main col-md-8">
            <div class="customer-details">
              <div class="commerce-address-fields">
                <h3>Shipping Address</h3>
                <% if @checkout_addresses.count > 0 %>
                  <div class="form-row form-row">
                    <label>
                      <h4>Pick an Address</h4>
                    </label>
                  </div>
                  <%= render "ecommerce/#{Ecommerce.ecommerce_layout}/checkout/pick_address_form" %>
                <% end %>
                <div class="form-row form-row">
                  <label>
                    <h4>Create a New Address</h4>
                  </label>
                </div>
                <%= render "ecommerce/#{Ecommerce.ecommerce_layout}/checkout/new_address_form" %>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="order-review-wrap">
              <h3>Your order</h3>
              <div class="commerce-checkout-review-order">
                <table class="shop_table commerce-checkout-review-order-table">
                  <thead>
                    <tr>
                      <th class="product-name">Product</th>
                      <th class="product-total">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @cart.cart_items.each do |item| %>
                      <tr class="cart_item">
                        <td class="product-name">
                          <%= item.product.name %>
                          <strong class="product-quantity">× <%= item.quantity %></strong>
                        </td>
                        <td class="product-total">
                          <span class="amount"><%= number_to_currency(item.line_total) %></span>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                  <tfoot>
                    <tr class="cart-subtotal">
                      <th>Subtotal</th>
                      <td><strong><span class="amount" style="display: inline;"><%= t('number.currency.format.unit') %></span><span class="amount" style="display: inline;" id="subtotal"><%= number_with_precision(@cart_subtotal) %></span></strong></td>
                    </tr>
                    <tr class="cart-subtotal">
                      <th>Shipping</th>
                      <td><span class="amount" style="display: inline;"><%= t('number.currency.format.unit') %></span><span class="amount" style="display: inline;" id="shipping-amount"><%= number_with_precision(0) %></span></td>
                    </tr>
                    <tr class="order-total">
                      <th>Total</th>
                      <td><strong><span class="amount" style="display: inline;"><%= t('number.currency.format.unit') %></span><span class="amount" style="display: inline;" id="payment-amount"><%= number_with_precision(@cart_subtotal) %></span></strong></td>
                    </tr>
                  </tfoot>
                </table>
                <div class="commerce-checkout-payment">
                  <ul class="payment_methods">
                    <% if @payment_credit_card_culqi %>

                    <li class="wc_payment_method payment_method_card">
                      <input id="payment_method_card" type="radio" checked="checked" class="input-radio" name="payment_method" value="card" />
                      <label for="payment_method_card">
                        Credit / Debit Card
                      </label>
                      <label for="payment_method_card">
                        <img src="https://s3.amazonaws.com/devtechperu-expatshop-dev/static/images/cards_row1.png" alt="Credit Card Images">
                        <img src="https://s3.amazonaws.com/devtechperu-expatshop-dev/static/images/cards_row2.png" alt="Credit Card Images">
                      </label>
                    </li>

                    <% end %>

                    <% if @payment_bank_deposit %>

                    <li>
                      <input id="payment_method_bank" type="radio" class="input-radio" name="payment_method" value="manual" checked="checked" />
                      <label for="payment_method_bank">
                        Bank Deposit
                      </label>
                      <div class="payment_box payment_method_cheque">
                        <p><%= @payment_bank_deposit.pre_message %></p>
                      </div>
                    </li>

                    <% end %>

                    <% if @payment_manual %>

                    <li>
                      <input id="payment_method_manual" type="radio" class="input-radio" name="payment_method" value="manual" checked="checked" />
                      <label for="payment_method_manual">
                        Manual Payment
                      </label>
                      <div class="payment_box payment_method_cheque">
                        <p><%= @payment_manual.pre_message %></p>
                      </div>
                    </li>

                    <% end %>

                  </ul>
                </div>
                <button class="button mt-5" id ="pay-now-button">Place Order</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <%= render "ecommerce/organici/store/prefooter" %>
  </div>


<!-- Incluyendo .js de Culqi Checkout-->
<script src="https://checkout.culqi.com/v2"></script>

<!-- Configurando el checkout-->
<script>

  Culqi.publicKey = "<%= ENV['CULQI_PUBLIC_KEY'] %>";
  var payment_amount = $('#payment-amount').html() * 100;
  var shipping_calculated_flag = false

  // calculate and update shipping html tag when shipping address is created
  $("#save-address-button").click(function() {
    calculate_shipping($("#address_street").val(), $("#address_district").val());
  });
  // calculate and update shipping html tag when shipping address is picked
  $('#address_id').on('change', function() {
    if ( this.value ) {
      calculate_shipping($("#address_street").val(), $("#address_district").val());
    } else {
      var my_zero = 0
      $("#shipping-amount").html(my_zero.toFixed(2))
      shipping_calculated_flag = false
    }
  })

  function calculate_shipping(street, district) {
    $.ajax({
      url: "calculate_shipping",
      dataType: "json",
      method: "POST",
      data: { address: street, district: district },
      success: function(data){
         $("#shipping-amount").html(data.amount.toFixed(2))
         recalculate_checkout_totals();
         shipping_calculated_flag = true
      }
    });
  }

  function recalculate_checkout_totals() {
    var total_amount = Number($("#shipping-amount").html()) + Number($("#subtotal").html())
    $('#payment-amount').html(total_amount.toFixed(2))
    payment_amount = $('#payment-amount').html() * 100;
    Culqi.settings({
      title: '<%= t('ecommerce.processor.culqi.payment_popup_title') %>',
      currency: 'PEN',
      description: '<%= "#{t('ecommerce.processor.culqi.order_label')} # #{@cart.id}" %>',
      amount: payment_amount
    });
  }

  $('#pay-now-button').on('click', function(e) {
    // Abre el formulario con las opciones de Culqi.settings
    if (shipping_calculated_flag) {
      if ($('input[name=payment_method]:checked').val() == "card") {
        Culqi.open();
        e.preventDefault();
      }
      else if ($('input[name=payment_method]:checked').val() == "manual") {
        manual_payment();
        e.preventDefault();
      }
    }
    else {
      // place error message here
      alert("You must pick or save an address");
    }
  });

  function culqi() {

    if(Culqi.token) { // ¡Token creado exitosamente!
        // Get the token ID:
        var token = Culqi.token;
        var picked_shipping_address_id = $('#address_id').val();
        var shipping_amount = $('#shipping-amount').html() * 100;
        var payment_amount = $('#payment-amount').html() * 100;
        //var payment_amount = $('#payment_amount').html() * 100;
        $.post(
          "checkout/pay_order_culqi_checkout",
          {
          culqi_token: token,
          amount: payment_amount,
          shipping_amount: shipping_amount,
          picked_shipping_address_id: picked_shipping_address_id,
          cart_id: '<%= "#{@cart.id}" if @cart %>'
          },
          function(data) {
          }
       );
       //alert('Se ha creado un token:' + token);

    }else{ // ¡Hubo algún problema!
        // Mostramos JSON de objeto error en consola
        console.log(Culqi.error);
        alert(Culqi.error.mensaje);
    }
  };

  function manual_payment() {
    var picked_shipping_address_id = $('#address_id').val();
    var shipping_amount = $('#shipping-amount').html() * 100;
    var payment_amount = $('#payment-amount').html() * 100;
    //var payment_amount = $('#payment_amount').html() * 100;
    $.post(
      "checkout/pay_order_manual",
      {
      amount: payment_amount,
      shipping_amount: shipping_amount,
      picked_shipping_address_id: picked_shipping_address_id,
      cart_id: '<%= "#{@cart.id}" if @cart %>'
      },
      function(data) {
      }
   );

  }

</script>
