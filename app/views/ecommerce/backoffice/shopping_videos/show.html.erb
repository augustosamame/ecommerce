<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left Column -->
    <div class="col-md-6">
      <div class="mb-3">
        <%= link_to 'Back', backoffice_shopping_videos_path, class: 'btn btn-sm btn-secondary mr-2' %>
        <%= link_to 'Edit', edit_backoffice_shopping_video_path(@shopping_video), class: 'btn btn-sm btn-primary' %>
      </div>

      <h1 class="mb-3"><%= @shopping_video.title %></h1>
      <p class="lead"><%= @shopping_video.description %></p>
      
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Video Details</h5>
          <p class="card-text"><strong>Video URL:</strong> <%= @shopping_video.video %></p>
          <p class="card-text"><strong>Priority:</strong> <%= @shopping_video.priority %></p>
          <p class="card-text"><strong>Status:</strong> <span class="badge badge-<%= @shopping_video.status == 'active' ? 'success' : 'secondary' %>"><%= @shopping_video.status %></span></p>
        </div>
      </div>

      <h2>Overlays</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" data-controller="datatable">
          <thead class="thead-dark">
            <tr>
              <th>Product</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% @shopping_video.shopping_video_overlays.each do |overlay| %>
              <tr>
                <td><%= overlay.product.name %></td>
                <td><%= overlay.start_time %> s</td>
                <td><%= overlay.end_time %> s</td>
                <td><span class="badge badge-<%= overlay.status == 'active' ? 'success' : 'secondary' %>"><%= overlay.status %></span></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Right Column (Video Player) -->
    <div class="col-md-6">
      <div class="video-container" style="height: 600px; max-height: 600px; position: relative;">
        <video
          id="my-video"
          class="video-js vjs-fill"
          controls
          muted
          preload="auto"
          poster="<%= @shopping_video.thumbnail %>"
        >
          <source src="<%= @shopping_video.video %>" type="video/mp4" />
          <p class="vjs-no-js">
            To view this video please enable JavaScript, and consider upgrading to a
            web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
          </p>
        </video>
      </div>
    </div>
  </div>
</div>

<link href="//vjs.zencdn.net/8.18.1/video-js.min.css" rel="stylesheet">
<script src="//vjs.zencdn.net/8.18.1/video.min.js"></script>

<style>
  .video-js .vjs-control-bar {
    height: 40px;
  }
  .vjs-overlay {
    position: absolute;
    bottom: 30px;
    left: 0;
    right: 0;
    height: 100px;
    background-color: transparent;
    overflow-x: auto;
    padding: 0 10px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
  }
  .product-overlay {
    display: none;
    padding: 0 5px;
  }
  .product-card {
    width: 160px;
    height: 80px;
    background-color: white;
    border-radius: 10px;
    display: flex;
    overflow: hidden;
  }
  .product-image {
    width: 33.33%;
    height: 100%;
    object-fit: contain;
    padding-left: 2px;
  }
  .product-info {
    width: 66.67%;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .product-title {
    font-size: 13px;
    color: #333;
    margin: 0;
    font-weight: bold;
  }
  .product-price {
    font-size: 13px;
    color: #666;
    margin: 0;
  }
  .add-to-cart {
    font-size: 13px;
    color: red;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .add-to-cart i {
    font-size: 14px;
  }
  .video-js .vjs-unmute-button {
    font-size: 1em;
    line-height: 2;
    height: 2em;
    padding: 0 0.5em;
    cursor: pointer;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var player = videojs('my-video', {
    autoplay: true,
    muted: true
  });

  var overlayContent = `
    <div class="vjs-overlay">
      <% @shopping_video.shopping_video_overlays.each do |overlay| %>
        <div class="product-overlay mx-2" data-product-id="<%= overlay.product.id %>" data-start-time="<%= overlay.start_time %>" data-end-time="<%= overlay.end_time %>">
          <div class="product-card">
            <img src="<%= overlay.product.image_url %>" class="product-image" alt="<%= overlay.product.name %>">
            <div class="product-info">
              <p class="product-title"><%= overlay.product.name %></p>
              <p class="product-price"><%= number_to_currency(overlay.product.price) %></p>
              <p class="add-to-cart">Add to Cart <i class="fas fa-arrow-right"></i></p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  `;

  player.ready(function() {
    var overlay = player.addChild('component', {
      el: player.addChild('component').el()
    });
    overlay.el().innerHTML = overlayContent;

    player.on('timeupdate', function() {
      var currentTime = player.currentTime();
      overlay.el().querySelectorAll('.product-overlay').forEach(function(productOverlay) {
        var startTime = parseFloat(productOverlay.dataset.startTime);
        var endTime = parseFloat(productOverlay.dataset.endTime);
        if (currentTime >= startTime && currentTime <= endTime) {
          productOverlay.style.display = 'block';
        } else {
          productOverlay.style.display = 'none';
        }
      });
    });

    overlay.el().querySelectorAll('.product-overlay').forEach(function(productOverlay) {
      productOverlay.addEventListener('click', function() {
        var productId = this.dataset.productId;
        console.log('Product clicked:', productId);
        // You can add more functionality here, like opening a modal or redirecting to the product page
      });
    });

    // Attempt to play the video
    player.play().then(function() {
      console.log('Autoplay started!');
    }).catch(function(error) {
      console.log('Autoplay was prevented:', error);
    });
  });
});
</script>